<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SET SALE CODE Á≥ªÁµ± (V18)</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="Êü•Ë≤®Code">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root { 
            --bg: #f2f2f7; --card: #ffffff; --text: #000000; 
            --red: #ff3b30; --blue: #007aff; --green: #34c759; 
            --key-light: #ffffff; --key-dark: #b2b2b2; 
            --color-a: #ff3b30; --color-b: #34c759; --color-c: #007aff; 
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); padding-bottom: 320px; user-select: none; -webkit-user-select: none; }
        
        #settings-panel { display: none; text-align: center; padding: 20px; background: #fff; border-radius: 14px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .status-bar { 
            background: #e5e5ea; color: #333; padding: 10px; 
            border-radius: 10px; text-align: center; font-size: 13px; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-sync { 
            background: var(--blue); color: white; border: none; 
            padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 13px; cursor: pointer; 
        }
        .btn-sync:active { opacity: 0.7; }

        #search-screen { display: block; }
        .header { background: var(--card); padding: 15px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; margin-bottom: 15px; position: sticky; top: 10px; z-index: 50; }
        h2 { margin: 0 0 5px 0; font-size: 1.2rem; color: #1c1c1e; }
        .db-info { font-size: 13px; color: #8e8e93; margin-bottom: 8px; }

        .input-wrapper { position: relative; width: 160px; margin: 0 auto; }
        .input-display { width: 100%; background: #e5e5ea; border: none; border-radius: 10px; padding: 12px; font-size: 28px; font-weight: 600; text-align: center; letter-spacing: 1px; color: #000; min-height: 40px; box-sizing: border-box; }
        .input-display.active::after { content: '|'; animation: blink 1s step-start infinite; color: var(--blue); margin-left: 2px; font-weight: normal; }
        @keyframes blink { 50% { opacity: 0; } }

        .list-box { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        .card { background: var(--card); border-radius: 14px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-head { padding: 10px 15px; color: white; font-weight: 600; font-size: 15px; }
        .bg-a { background: var(--color-a); } .bg-b { background: var(--color-b); } .bg-c { background: var(--color-c); }

        .list-body { display: flex; flex-direction: column; }
        .swipe-container { width: 100%; border-bottom: 1px solid #e5e5ea; max-height: 200px; transition: max-height 0.3s ease, opacity 0.3s ease; }
        .swipe-container:last-child { border-bottom: none; }
        .swipe-container.deleting { max-height: 0; opacity: 0; border: none; overflow: hidden; }
        .swipe-scroll { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none; }
        .swipe-scroll::-webkit-scrollbar { display: none; }
        .swipe-content { flex: 0 0 100%; scroll-snap-align: start; display: flex; padding: 12px 10px; background: #fff; box-sizing: border-box; }
        .swipe-action { flex: 0 0 80px; scroll-snap-align: end; background: var(--red); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 16px; cursor: pointer; }

        .code { font-weight: 700; font-family: monospace; font-size: 1.3em; width: 50px; flex-shrink: 0; color: #1c1c1e; }
        .content-cell { display: flex; justify-content: space-between; align-items: flex-start; flex: 1; }
        .info-col { padding-right: 5px; flex: 1; }
        .info { font-size: 16px; font-weight: 500; line-height: 1.3; margin-bottom: 4px; word-wrap: break-word; }
        .model-txt { color: var(--blue); font-size: 0.9em; margin-top: 2px; font-weight: 500; }
        
        /* ‚ùóÔ∏è Ê≥®ÊÑè‰∫ãÈ†Ö Icon */
        .note-icon { display: inline-block; font-size: 18px; margin-left: 5px; cursor: pointer; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
        
        .tag { display: inline-block; background: #f2f2f7; padding: 3px 8px; border-radius: 6px; font-size: 13px; color: #8e8e93; font-weight: 500; margin-top: 4px; }

        .chk-col { display: flex; gap: 8px; flex-shrink: 0; }
        .chk-box { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .chk-label { font-size: 11px; font-weight: 700; color: #8e8e93; margin-bottom: 2px; }
        input[type="checkbox"] { appearance: none; width: 24px; height: 24px; border: 2px solid #c7c7cc; border-radius: 4px; background-color: white; position: relative; }
        input[type="checkbox"]:checked { background-color: var(--blue); border-color: var(--blue); }
        input[type="checkbox"]:checked::after { content: '‚úî'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 16px; }

        .footer-action { text-align: center; margin-top: 30px; margin-bottom: 30px; }
        .btn-reset { background: var(--red); color: white; border: none; padding: 12px 40px; border-radius: 25px; font-size: 15px; font-weight: 600; }

        #custom-keyboard { position: fixed; bottom: 0; left: 0; width: 100%; background: #d1d5db; backdrop-filter: blur(10px); padding: 6px; padding-bottom: 25px; box-sizing: border-box; z-index: 1000; display: none; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .kb-key { background: var(--key-light); color: #000; border: none; border-radius: 5px; height: 52px; font-size: 22px; font-weight: 400; box-shadow: 0 1px 0 #898a8d; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .kb-key:active { background: #e5e5ea; }
        .k-abc { font-weight: 500; } .k-num { font-weight: 400; font-size: 24px; }
        .k-del { background: #adb3bc; color: #000; font-size: 18px; } .k-del:active { background: #fff; }
        .k-go { background: var(--blue); color: white; font-size: 17px; font-weight: 600; } .k-go:active { background: #0056b3; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: #f2f2f7; padding: 20px; border-radius: 14px; width: 85%; max-width: 300px; text-align: center; max-height: 70vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .opt-btn { width: 100%; margin: 6px 0; padding: 14px; font-size: 16px; background: #fff; border: none; border-radius: 10px; text-align: center; color: var(--blue); font-weight: 500; }
        .opt-btn:active { background: #e5e5ea; }
        #alert-title { font-size: 1.2rem; color: var(--red); margin-bottom: 10px; display: block; }
        #alert-msg { font-size: 1.1rem; color: #333; line-height: 1.5; white-space: pre-wrap; }
        .config-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 14px; }
        .btn-save { background: #34c759; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; width: 100%; }
    </style>
</head>
<body>

    <div id="settings-panel">
        <h3>‚öôÔ∏è Ë≥áÊñô‰æÜÊ∫êË®≠ÂÆö</h3>
        <p style="font-size:13px; color:#666; margin-bottom:10px;">Ë´ãË≤º‰∏ä Google Sheet CSV ÈÄ£Áµê</p>
        <input type="text" id="sheet-url" class="config-input" placeholder="https://docs.google.com...">
        <button class="btn-save" onclick="saveConfig()">ÂÑ≤Â≠ò‰∏¶Êõ¥Êñ∞</button>
        <br><br>
        <button onclick="closeSettings()" style="background:none; border:none; color:#999; text-decoration:underline;">ÂèñÊ∂à</button>
    </div>

    <div id="search-screen">
        <div class="status-bar">
            <span id="last-update">Á≠âÂæÖÊõ¥Êñ∞...</span>
            <button class="btn-sync" onclick="syncData()">üîÑ Êõ¥Êñ∞Ë≥áÊñô</button>
        </div>

        <div class="header">
            <h2>SET SALE CODE</h2>
            <div class="db-info">Ë≥áÊñôÂ∫´: <span id="db-count">0</span> Á≠Ü | Â∑¶ÊªëÂà™Èô§</div>
            <div class="input-wrapper">
                <div id="display-box" class="input-display active" onclick="focusInput()"></div>
            </div>
        </div>

        <div class="list-box">
            <div class="card"><div class="card-head bg-a">A ÁµÑ</div><div id="tb-a" class="list-body"></div></div>
            <div class="card"><div class="card-head bg-b">B ÁµÑ</div><div id="tb-b" class="list-body"></div></div>
            <div class="card"><div class="card-head bg-c">C ÁµÑ</div><div id="tb-c" class="list-body"></div></div>
        </div>

        <div class="footer-action">
            <button class="btn-reset" onclick="resetAll()">üóëÔ∏è Ê∏ÖÈô§ÁµêÊûú</button>
            <div style="margin-top:20px;">
                <button onclick="openSettings()" style="color:#8e8e93; background:none; border:none; text-decoration:underline; font-size:13px;">‚öôÔ∏è Ë®≠ÂÆöÈÄ£Áµê</button>
            </div>
        </div>
    </div>

    <div id="custom-keyboard">
        <button class="kb-key k-abc" onmousedown="tap('A')" ontouchstart="tap('A')">A</button>
        <button class="kb-key k-num" onmousedown="tap('1')" ontouchstart="tap('1')">1</button>
        <button class="kb-key k-num" onmousedown="tap('2')" ontouchstart="tap('2')">2</button>
        <button class="kb-key k-num" onmousedown="tap('3')" ontouchstart="tap('3')">3</button>
        <button class="kb-key k-del" onmousedown="tap('DEL')" ontouchstart="tap('DEL')">‚å´</button>

        <button class="kb-key k-abc" onmousedown="tap('B')" ontouchstart="tap('B')">B</button>
        <button class="kb-key k-num" onmousedown="tap('4')" ontouchstart="tap('4')">4</button>
        <button class="kb-key k-num" onmousedown="tap('5')" ontouchstart="tap('5')">5</button>
        <button class="kb-key k-num" onmousedown="tap('6')" ontouchstart="tap('6')">6</button>
        <button class="kb-key k-num" onmousedown="tap('0')" ontouchstart="tap('0')">0</button>

        <button class="kb-key k-abc" onmousedown="tap('C')" ontouchstart="tap('C')">C</button>
        <button class="kb-key k-num" onmousedown="tap('7')" ontouchstart="tap('7')">7</button>
        <button class="kb-key k-num" onmousedown="tap('8')" ontouchstart="tap('8')">8</button>
        <button class="kb-key k-num" onmousedown="tap('9')" ontouchstart="tap('9')">9</button>
        <button class="kb-key k-go" onmousedown="tap('GO')" ontouchstart="tap('GO')">GO</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <b id="m-code" style="font-size:1.6em; color:var(--blue); display:block; margin-bottom:15px;"></b>
            <div id="alert-area" style="display:none; text-align:left; margin-bottom:15px;">
                <b id="alert-title">‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</b>
                <span id="alert-msg"></span>
            </div>
            <div id="m-list"></div>
            <button onclick="closeM()" style="margin-top:15px; background:#fff; color:var(--red); padding:12px; width:100%; border:none; border-radius:10px; font-weight:600;">ÈóúÈñâ</button>
        </div>
    </div>

    <script>
        window.onerror = function(msg) { alert("Á≥ªÁµ±Áï∞Â∏∏: " + msg); return false; };
        let db = {};
        let currentInput = "";
        let audioCtx = null;
        let csvUrl = localStorage.getItem('sheet_url_v15') || "";

        window.onload = function() {
            const savedData = localStorage.getItem('productData_v15');
            const savedTime = localStorage.getItem('updateTime_v15');
            if(savedData && savedData.length > 20) {
                parseData(savedData);
                document.getElementById('last-update').innerText = "ÊúÄÂæåÊõ¥Êñ∞: " + (savedTime || "Êú™Áü•");
            } else {
                if(!csvUrl) openSettings();
            }
            document.getElementById('custom-keyboard').style.display = 'grid';
        };

        function syncData() {
            if(!csvUrl) { alert("Ë´ãÂÖàË®≠ÂÆö Google Sheet ÈÄ£ÁµêÔºÅ"); openSettings(); return; }
            const btn = document.querySelector('.btn-sync');
            btn.innerText = "ÈÄ£Á∑ö‰∏≠...";
            
            fetch(csvUrl)
            .then(response => { if (!response.ok) throw new Error("Direct Failed"); return response.text(); })
            .then(text => handleSuccess(text))
            .catch(err => {
                console.log("Direct failed, trying proxy...");
                btn.innerText = "ÂòóË©¶‰∏≠ËΩâ...";
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl);
                fetch(proxyUrl)
                .then(response => { if (!response.ok) throw new Error("Proxy Failed"); return response.text(); })
                .then(text => handleSuccess(text))
                .catch(finalErr => {
                    alert("‚ùå Êõ¥Êñ∞Â§±ÊïóÔºÅË´ãÊ™¢Êü•ÈÄ£ÁµêÊàñÁ∂≤Áµ°„ÄÇ");
                    btn.innerText = "üîÑ Êõ¥Êñ∞Ë≥áÊñô";
                });
            });
        }

        function handleSuccess(text) {
            const now = new Date().toLocaleString();
            localStorage.setItem('productData_v15', text);
            localStorage.setItem('updateTime_v15', now);
            if(parseData(text)) {
                document.getElementById('last-update').innerText = "ÊúÄÂæåÊõ¥Êñ∞: " + now;
                const btn = document.querySelector('.btn-sync');
                btn.innerText = "‚úÖ ÊàêÂäü";
                setTimeout(() => btn.innerText = "üîÑ Êõ¥Êñ∞Ë≥áÊñô", 2000);
            } else { alert("‚ö†Ô∏è Ë≥áÊñôÊ†ºÂºèÊúâË™§"); }
        }

        // ==========================================
        // V18 ÁµÇÊ•µËß£ËÆÄÂô®ÔºöÂÆåÁæéÂ∞çÊáâÈÄóËôü„ÄÅÁ©∫Ê†º„ÄÅÊºèÊ¨ÑÂïèÈ°å
        // ==========================================
        function parseData(text) {
            db = {}; let count = 0; 
            const lines = text.split(/\r\n|\n|\r/);
            lines.forEach(line => {
                if(!line.trim()) return;
                
                let cols = [];
                if(line.includes('|') && !line.includes('","')) {
                    cols = line.split('|'); 
                } else {
                    // ÂÖ®Êñ∞ÈÄêÂ≠óËß£Á¢ºÂô®Ôºå100% Á≤æÊ∫ñËôïÁêÜ CSV
                    let cur = '', inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        let char = line[i];
                        if (char === '"') {
                            inQuote = !inQuote;
                        } else if (char === ',' && !inQuote) {
                            cols.push(cur);
                            cur = '';
                        } else {
                            cur += char;
                        }
                    }
                    cols.push(cur); // ÊîæÂÖ•ÊúÄÂæå‰∏ÄÊ¨Ñ
                }

                if(cols.length < 2) return;
                
                const clean = (s) => s ? s.replace(/^"|"$/g, '').trim() : '';
                
                const item = {
                    code: clean(cols[0]), 
                    name: clean(cols[1]), 
                    model: clean(cols[2]), 
                    cargo: clean(cols[3]), 
                    group: clean(cols[4]),
                    // Â∞áÁ¨¨ 6 Ê¨Ñ‰ª•ÂèäÂæåÈù¢Â§öÈ§òÂòÖÊ¨Ñ‰ΩçÂÆâÂÖ®Âú∞ÈßÅÂüã‰∏ÄÈΩä (Ëß£Ê±∫ÈÄóËôüÊñ∑Â≠ó)
                    note: cols.slice(5).map(clean).join(', ').replace(/^, | , $/g, '').trim()
                };
                
                if(item.code.toLowerCase() === 'code' || item.code === '‰ª£Á¢º') return;

                let k = item.code.toLowerCase(); 
                if(!db[k]) db[k] = []; 
                db[k].push(item); 
                count++;
            });
            document.getElementById('db-count').innerText = count; 
            return count > 0;
        }

        function openSettings() { document.getElementById('settings-panel').style.display = 'block'; document.getElementById('search-screen').style.display = 'none'; document.getElementById('sheet-url').value = csvUrl; }
        function closeSettings() { document.getElementById('settings-panel').style.display = 'none'; document.getElementById('search-screen').style.display = 'block'; }
        function saveConfig() { const url = document.getElementById('sheet-url').value.trim(); if(url) { csvUrl = url; localStorage.setItem('sheet_url_v15', url); closeSettings(); syncData(); } else { alert("Ë´ãËº∏ÂÖ•ÈÄ£Áµê"); } }

        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state === 'suspended') audioCtx.resume(); }
        function playTone(type) { try { initAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); if(type==='click'){o.frequency.value=500;g.gain.value=0.5;o.start();o.stop(audioCtx.currentTime+0.03);} else if(type==='del'){o.frequency.value=300;g.gain.value=0.5;o.start();o.stop(audioCtx.currentTime+0.05);} else if(type==='go'){o.frequency.value=800;g.gain.value=0.5;o.start();o.stop(audioCtx.currentTime+0.1);} else if(type==='trash'){o.type='square';o.frequency.value=150;g.gain.value=0.2;o.start();o.stop(audioCtx.currentTime+0.1);} } catch(e){} }
        function triggerVibration() { try { if (navigator.vibrate) navigator.vibrate(10); } catch(e) {} }
        function tap(key) { event.preventDefault(); triggerVibration(); if (key === 'DEL') { playTone('del'); if (currentInput.length > 0) currentInput = currentInput.slice(0, -1); } else if (key === 'GO') { playTone('go'); runSearch(); return; } else { playTone('click'); if (currentInput.length < 6) currentInput += key; } updateDisplay(); }
        
        function updateDisplay() { document.getElementById('display-box').innerText = currentInput; }
        function clearInput() { currentInput = ""; playTone('del'); updateDisplay(); }
        function focusInput() {}
        
        function runSearch() { 
            const val = currentInput.trim().toLowerCase(); 
            if(!val) return; 
            const res = db[val]; 
            
            if(!res) { 
                if(navigator.vibrate) navigator.vibrate([30,50,30]); 
                alert('‚ö†Ô∏è Êâæ‰∏çÂà∞: ' + currentInput); 
                clearInput(); // V17 ÂäüËÉΩÔºöÈåØË™§Ëá™ÂãïÊ∏ÖÁ©∫
                return; 
            } 
            
            const groups = [...new Set(res.map(i => i.group))]; 
            if(groups.length === 1) { add(res); clearInput(); } else { openM(currentInput.toUpperCase(), groups, res); } 
        }
        
        function resetList() { document.getElementById('tb-a').innerHTML=''; document.getElementById('tb-b').innerHTML=''; document.getElementById('tb-c').innerHTML=''; }
        function deleteBatch(id) { playTone('trash'); if(navigator.vibrate) navigator.vibrate(20); document.querySelectorAll('.'+id).forEach(el => { el.classList.add('deleting'); setTimeout(()=>el.remove(),300); }); }
        
        function add(items) {
            const bid = 'batch-' + Date.now();
            items.forEach(i => {
                let tid = 'tb-c'; const c = i.code.charAt(0).toLowerCase(); if(c==='a') tid='tb-a'; if(c==='b') tid='tb-b';
                
                let noteHtml = '';
                if(i.note && i.note.length > 0) { 
                    const safeNote = i.note.replace(/"/g, '&quot;').replace(/'/g, "\\'"); 
                    noteHtml = `<span class="note-icon" onclick="showAlert('${safeNote}')">‚ùóÔ∏è</span>`; 
                }

                const row = document.createElement('div'); row.className = `swipe-container ${bid}`;
                row.innerHTML = `<div class="swipe-scroll"><div class="swipe-content"><div class="code">${i.code}</div><div class="content-cell"><div class="info-col"><div class="info">${i.name} ${noteHtml}</div><div class="model-txt">ÂûãËôü: ${i.model}</div><span class="tag">${i.cargo}</span></div><div class="chk-col"><div class="chk-box"><div class="chk-label">DC</div><input type="checkbox"></div><div class="chk-box"><div class="chk-label">KB</div><input type="checkbox"></div></div></div></div><div class="swipe-action" onclick="deleteBatch('${bid}')">Âà™Èô§</div></div>`;
                const tb = document.getElementById(tid); tb.insertBefore(row, tb.firstChild);
            });
        }
        
        function showAlert(msg) { event.stopPropagation(); const m = document.getElementById('modal'); document.getElementById('m-code').innerText = ''; document.getElementById('m-list').innerHTML = ''; document.getElementById('alert-area').style.display = 'block'; document.getElementById('alert-msg').innerText = msg; m.style.display = 'flex'; }
        function openM(code, groups, items) { const m = document.getElementById('modal'); const list = document.getElementById('m-list'); document.getElementById('alert-area').style.display = 'none'; document.getElementById('m-code').innerText = code; list.innerHTML = ''; groups.forEach(g => { const btn = document.createElement('button'); btn.className = 'opt-btn'; btn.innerHTML = `<b>${g || 'Ê®ôÊ∫ñÁâà / Â•óË£ù'}</b>`; btn.onclick = () => { playTone('click'); triggerVibration(); add(items.filter(i=>i.group===g)); closeM(); clearInput(); }; list.appendChild(btn); }); m.style.display = 'flex'; }
        function closeM() { document.getElementById('modal').style.display = 'none'; }
        function resetAll() { if(confirm('Ê∏ÖÈô§ÊâÄÊúâÁµêÊûúÔºü')) { resetList(); clearInput(); } }
        function clearCache() { if(confirm('ÈáçË®≠Â∞áÊúÉÊ∏ÖÈô§Ë≥áÊñôÔºåÁ¢∫ÂÆöÔºü')) { try{localStorage.removeItem('productData_v15');}catch(e){} location.reload(); } }
    </script>
</body>
</html>